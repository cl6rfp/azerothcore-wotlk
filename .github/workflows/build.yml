name: Build AzerothCore for Windows

on:
  workflow_dispatch:

jobs:
  build:
    runs-on: windows-latest

    steps:
    - name: Checkout repo
      uses: actions/checkout@v3
      with:
        submodules: true

    - name: Install all dependencies with Boost
      run: |
        # Lista de mirrors alternativos
        $mirrors = @(
            "https://boostorg.jfrog.io/artifactory/main/release/1.83.0/binaries/boost_1_83_0-msvc-14.2-64.7z",
            "https://sourceforge.net/projects/boost/files/boost-binaries/1.83.0/boost_1_83_0-msvc-14.2-64.7z/download",
            "https://dl.bintray.com/boostorg/release/1.83.0/binaries/boost_1_83_0-msvc-14.2-64.7z"
        )
        
        choco install cmake git ninja python mariadb vcredist140 7zip curl -y
        
        # Intentar descarga desde cada mirror
        foreach ($url in $mirrors) {
            try {
                Write-Output "Intentando descargar desde: $url"
                curl -L $url --output boost.7z --progress-bar --retry 3
                if (Test-Path boost.7z) {
                    7z t boost.7z && 7z x boost.7z -oC:\boost -y && del boost.7z
                    Write-Output "¡Boost instalado correctamente!"
                    exit 0
                }
            } catch {
                Write-Output "Falló mirror: $url"
            }
        }
        throw "Todos los mirrors fallaron"
        
    - name: Configure and Build
      run: |
        cmake -S . -B build -G "Ninja" `
          -DWITH_ELUNA=ON `
          -DCMAKE_BUILD_TYPE=Release `
          -DBOOST_ROOT="C:\boost" `
          -DBoost_LIBRARY_DIR="C:\boost\lib64-msvc-14.2" &&
        cmake --build build --parallel 4
